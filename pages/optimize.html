{% extends "partials/base.html" %}
{% block title %}Resume Analysis - AI Resume Coach{% endblock %}

{% block content %}
<div class="page-optimize">
    <div class="container">
        
        <!-- Step 1: Resume Upload (Primary) -->
        <div class="upload-card primary-card">
            <div class="card-header">
                <div class="step-indicator">Step 1 of 2</div>
                <div class="card-title">
                    <h2>Upload Your Resume</h2>
                    <p>Upload your resume. We'll check ATS compatibility and keyword matches.</p>
                </div>
                <div class="card-status" id="resume-status">
                    <i class="fas fa-circle"></i>
                </div>
            </div>

            <!-- Upload Options -->
            <div class="upload-tabs">
                <button type="button" class="tab-option active" data-option="file" onclick="switchUploadOption('file')">
                    <i class="fas fa-cloud-upload"></i>
                    Upload File
                </button>
                <button type="button" class="tab-option" data-option="text" onclick="switchUploadOption('text')">
                    <i class="fas fa-edit"></i>
                    Paste Text
                </button>
            </div>

            <!-- File Upload -->
            <div class="upload-area" id="file-upload-area">
                <div class="drop-zone" id="drop-zone">
                    <div class="drop-content">
                        <i class="fas fa-cloud-upload-alt fa-2x"></i>
                        <h3>Drag & drop your resume here</h3>
                        <p>or <button type="button" class="link-btn" id="browse-btn">choose from computer</button></p>
                        <div class="file-formats">PDF, DOCX, TXT • Max 5MB</div>
                    </div>
                </div>
                <input type="file" id="file-input" accept=".pdf,.docx,.txt" hidden>
                <div id="file-success" class="upload-success" style="display: none;"></div>
            </div>

            <!-- Text Upload -->
            <div class="upload-area" id="text-upload-area" style="display: none;">
                <div class="text-input-wrapper">
                    <textarea id="resume-text" placeholder="Paste your complete resume text here...

Example:
Alex Johnson
Senior Software Engineer
alex.johnson@email.com | (555) 123-4567

PROFESSIONAL EXPERIENCE

Senior Software Engineer | TechCorp Inc. | 2021-Present
• Led development of microservices architecture serving 2M+ users daily
• Reduced system response time by 45% through performance optimization
• Mentored team of 6 engineers and established code review best practices
• Technologies: Python, React, PostgreSQL, AWS, Docker

Software Engineer | StartupXYZ | 2019-2021
• Built scalable web applications using modern JavaScript frameworks
• Implemented CI/CD pipelines reducing deployment time by 60%
• Collaborated with product team on user experience improvements

CORE SKILLS
Languages: Python, JavaScript, TypeScript, Java
Frameworks: React, Node.js, Django, Flask
Tools: Git, Docker, AWS, Jenkins, PostgreSQL" rows="14"></textarea>
                    <div class="char-count" id="char-count">0 characters</div>
                </div>
            </div>

            <div class="upload-help">
                <i class="fas fa-shield-alt"></i>
                Your resume is processed securely and deleted after analysis.
            </div>
        </div>

        <!-- Step 2: Target Job (Secondary/Collapsible) -->
        <div class="upload-card secondary-card">
            <div class="card-header" onclick="toggleJobSection()">
                <div class="step-indicator">Step 2 of 2 (Optional)</div>
                <div class="card-title">
                    <h2>Add Target Job <span class="expand-icon" id="expand-icon"><i class="fas fa-plus"></i></span></h2>
                    <p>Adding a job helps us match your resume more accurately.</p>
                </div>
                <div class="card-status" id="job-status">
                    <span class="optional-label">Optional</span>
                </div>
            </div>

            <!-- Collapsible Job Content -->
            <div class="job-content" id="job-content" style="display: none;">
                <div class="job-input-section">
                    <div class="form-group">
                        <label for="job-title">Job Title</label>
                        <input type="text" id="job-title" class="form-input" placeholder="e.g., Senior Software Engineer">
                    </div>
                    
                    <div class="form-group">
                        <label for="job-description">Job Description</label>
                        <textarea id="job-description" rows="8" class="form-input" 
                            placeholder="Paste the complete job posting here...

We are looking for a Senior Software Engineer to join our growing engineering team...

RESPONSIBILITIES:
• Design and develop scalable web applications
• Lead technical architecture decisions
• Mentor junior developers and conduct code reviews
• Collaborate with product and design teams

REQUIREMENTS:
• 5+ years of software development experience
• Strong proficiency in Python and JavaScript
• Experience with cloud platforms (AWS, Azure, or GCP)
• Bachelor's degree in Computer Science or equivalent"></textarea>
                        <div class="char-count" id="job-char-count">0 characters</div>
                    </div>
                </div>

                <div class="upload-help">
                    <i class="fas fa-bullseye"></i>
                    We'll analyze keyword matches and highlight transferable skills for this specific role.
                </div>
            </div>
        </div>

    </div>

    <!-- Sticky CTA -->
    <div class="sticky-cta">
        <div class="cta-content">
            <button type="button" class="btn btn-primary btn-cta" id="analyze-btn" disabled onclick="startAnalysis()">
                <i class="fas fa-magic"></i>
                <span id="cta-text">Analyze My Resume</span>
            </button>
            <div class="cta-help">Get insights in under 30 seconds</div>
        </div>
    </div>

    <!-- Messages -->
    <div id="messages" class="messages-container"></div>

</div>
{% endblock %}

{% block extra_js %}
<script>
let resumeData = null;
let jobData = { title: '', description: '' };
let jobSectionExpanded = false;

document.addEventListener('DOMContentLoaded', function() {
    setupUploadHandlers();
    updateValidation();
});

function switchUploadOption(option) {
    // Update tab buttons
    document.querySelectorAll('.tab-option').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-option="${option}"]`).classList.add('active');
    
    // Show/hide upload areas
    if (option === 'file') {
        document.getElementById('file-upload-area').style.display = 'block';
        document.getElementById('text-upload-area').style.display = 'none';
    } else {
        document.getElementById('file-upload-area').style.display = 'none';
        document.getElementById('text-upload-area').style.display = 'block';
    }
    
    clearResumeData();
    updateValidation();
}

function setupUploadHandlers() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const browseBtn = document.getElementById('browse-btn');
    const resumeText = document.getElementById('resume-text');
    const jobTitle = document.getElementById('job-title');
    const jobDescription = document.getElementById('job-description');
    
    // File upload handlers
    if (browseBtn) {
        browseBtn.addEventListener('click', () => fileInput.click());
    }
    
    if (dropZone) {
        dropZone.addEventListener('click', (e) => {
            if (e.target !== browseBtn) fileInput.click();
        });
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files[0]) {
                handleFileUpload(e.dataTransfer.files[0]);
            }
        });
    }
    
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                handleFileUpload(e.target.files[0]);
            }
        });
    }
    
    // Text input handler
    if (resumeText) {
        resumeText.addEventListener('input', function() {
            resumeData = { type: 'text', content: this.value };
            document.getElementById('char-count').textContent = `${this.value.length} characters`;
            updateValidation();
        });
    }
    
    // Job input handlers
    if (jobTitle) {
        jobTitle.addEventListener('input', function() {
            jobData.title = this.value;
            updateValidation();
        });
    }
    
    if (jobDescription) {
        jobDescription.addEventListener('input', function() {
            jobData.description = this.value;
            document.getElementById('job-char-count').textContent = `${this.value.length} characters`;
            updateValidation();
        });
    }
}

function handleFileUpload(file) {
    // Validate file
    if (file.size > 5 * 1024 * 1024) {
        showMessage('File size must be less than 5MB', 'error');
        return;
    }
    
    const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
    if (!allowedTypes.includes(file.type)) {
        showMessage('Please upload PDF, DOCX, or TXT files only', 'error');
        return;
    }
    
    resumeData = { type: 'file', content: file };
    
    // Show success state
    document.getElementById('file-success').innerHTML = `
        <div class="success-content">
            <div class="success-info">
                <i class="fas fa-check-circle"></i>
                <div class="file-details">
                    <strong>${file.name}</strong>
                    <span>${(file.size/1024/1024).toFixed(1)} MB</span>
                </div>
            </div>
            <button onclick="clearFile()" class="remove-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    document.getElementById('file-success').style.display = 'block';
    
    showMessage('Resume uploaded successfully!', 'success');
    updateValidation();
}

function clearFile() {
    resumeData = null;
    document.getElementById('file-success').style.display = 'none';
    document.getElementById('file-input').value = '';
    updateValidation();
}

function clearResumeData() {
    resumeData = null;
    
    // Clear file
    document.getElementById('file-success').style.display = 'none';
    document.getElementById('file-input').value = '';
    
    // Clear text
    const textArea = document.getElementById('resume-text');
    if (textArea) {
        textArea.value = '';
        document.getElementById('char-count').textContent = '0 characters';
    }
    
    clearMessages();
}

function toggleJobSection() {
    const jobContent = document.getElementById('job-content');
    const expandIcon = document.getElementById('expand-icon');
    const jobCard = document.querySelector('.secondary-card');
    
    if (jobSectionExpanded) {
        // Collapse
        jobContent.style.display = 'none';
        expandIcon.innerHTML = '<i class="fas fa-plus"></i>';
        jobCard.classList.remove('expanded');
        jobSectionExpanded = false;
    } else {
        // Expand
        jobContent.style.display = 'block';
        expandIcon.innerHTML = '<i class="fas fa-minus"></i>';
        jobCard.classList.add('expanded');
        jobSectionExpanded = true;
    }
}

function updateValidation() {
    const hasResume = resumeData && 
        (resumeData.type === 'file' || 
         (resumeData.type === 'text' && resumeData.content.trim().length > 100));
    
    const hasJob = jobData.title.trim() || jobData.description.trim().length > 50;
    
    // Update resume status
    const resumeStatus = document.getElementById('resume-status');
    if (hasResume) {
        resumeStatus.innerHTML = '<i class="fas fa-check-circle"></i>';
        resumeStatus.classList.add('completed');
    } else {
        resumeStatus.innerHTML = '<i class="fas fa-circle"></i>';
        resumeStatus.classList.remove('completed');
    }
    
    // Update job status
    const jobStatus = document.getElementById('job-status');
    if (hasJob) {
        jobStatus.innerHTML = '<i class="fas fa-check-circle"></i>';
        jobStatus.classList.add('completed');
    } else {
        jobStatus.innerHTML = '<span class="optional-label">Optional</span>';
        jobStatus.classList.remove('completed');
    }
    
    // Update CTA button
    const analyzeBtn = document.getElementById('analyze-btn');
    const ctaText = document.getElementById('cta-text');
    
    analyzeBtn.disabled = !hasResume;
    
    if (hasResume && hasJob) {
        ctaText.textContent = 'Analyze Resume Against Job';
    } else if (hasResume) {
        ctaText.textContent = 'Analyze My Resume';
    } else {
        ctaText.textContent = 'Upload Resume First';
    }
}

function startAnalysis() {
    if (!resumeData) {
        showMessage('Please upload your resume first', 'error');
        return;
    }
    
    // Store data for next step
    sessionStorage.setItem('resume_data', JSON.stringify(resumeData));
    sessionStorage.setItem('job_data', JSON.stringify(jobData));
    
    showMessage('Starting AI analysis...', 'success');
}

function showMessage(text, type) {
    const container = document.getElementById('messages');
    const icons = {
        success: 'check-circle',
        error: 'exclamation-triangle',
        warning: 'info-circle'
    };
    
    container.innerHTML = `
        <div class="message ${type}">
            <i class="fas fa-${icons[type]}"></i>
            ${text}
        </div>
    `;
    
    if (type === 'success') {
        setTimeout(() => container.innerHTML = '', 4000);
    }
}

function clearMessages() {
    document.getElementById('messages').innerHTML = '';
}
</script>
<!-- Include optimization API integration -->
<script src="{{ url_for('static', filename='js/optimization.js') }}"></script>
{% endblock %}
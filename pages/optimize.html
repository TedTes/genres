{% extends "partials/base.html" %}
{% block title %}Optimize Resume - AI Resume Coach{% endblock %}

{% block content %}
<div class="page-optimize">
    <section class="upload-section">
        <div class="container">
            <div class="upload-container card">
                
                <!-- Upload Type Selection -->
                <div class="upload-selector">
                    <button type="button" class="upload-type-btn active" data-type="file" onclick="switchUploadType('file')">
                        <i class="fas fa-file-upload"></i>
                        Upload File
                    </button>
                    <button type="button" class="upload-type-btn" data-type="text" onclick="switchUploadType('text')">
                        <i class="fas fa-keyboard"></i>
                        Paste Text
                    </button>
                </div>

                <!-- File Upload Section -->
                <div class="upload-content" id="file-upload" style="display: block;">
                    <div class="drop-zone" id="drop-zone">
                        <div class="drop-content">
                            <i class="fas fa-cloud-upload-alt fa-3x"></i>
                            <h3>Drop your resume here</h3>
                            <p>or <button type="button" class="browse-btn" id="browse-btn">choose file</button></p>
                            <small>PDF, DOCX, TXT • Max 5MB</small>
                        </div>
                    </div>
                    <input type="file" id="file-input" accept=".pdf,.docx,.txt" hidden>
                    <div id="file-result" class="file-result" style="display: none;"></div>
                    <div class="help-text">
                        <i class="fas fa-info-circle"></i>
                        We'll analyze formatting, keywords, and ATS compatibility
                    </div>
                </div>

                <!-- Text Upload Section -->
                <div class="upload-content" id="text-upload" style="display: none;">
                    <div class="text-area-wrapper">
                        <textarea id="resume-textarea" placeholder="Paste your resume text here...

Example format:
John Smith
Software Engineer
john@email.com | (555) 123-4567

EXPERIENCE
Software Developer at TechCorp (2020-2023)
• Built web applications using Python and React
• Collaborated on database design and optimization
• Implemented REST APIs for client integrations

SKILLS
Python, JavaScript, SQL, React, Git" rows="12"></textarea>
                        <div class="char-counter">
                            <span id="char-counter">0</span> characters
                        </div>
                    </div>
                    <div class="help-text">
                        <i class="fas fa-magic"></i>
                        Include your complete work history and skills for best results
                    </div>
                </div>

                <!-- Continue Button -->
                <div class="upload-actions">
                    <button type="button" class="btn btn-primary btn-lg" id="continue-button" disabled onclick="proceedToNextStep()">
                        <i class="fas fa-arrow-right"></i>
                        Continue to Job Description
                    </button>
                </div>

                <!-- Messages -->
                <div id="upload-messages"></div>
                
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentFile = null;
let currentText = '';

document.addEventListener('DOMContentLoaded', function() {
    initializeUpload();
});

function initializeUpload() {
    setupFileUpload();
    setupTextUpload();
}

function switchUploadType(type) {
    // Update buttons
    document.querySelectorAll('.upload-type-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-type="${type}"]`).classList.add('active');
    
    // Show/hide content
    if (type === 'file') {
        document.getElementById('file-upload').style.display = 'block';
        document.getElementById('text-upload').style.display = 'none';
    } else {
        document.getElementById('file-upload').style.display = 'none';
        document.getElementById('text-upload').style.display = 'block';
    }
    
    // Reset and validate
    resetInputs();
    validateContinue();
}

function setupFileUpload() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const browseBtn = document.getElementById('browse-btn');
    
    // Browse button
    browseBtn.addEventListener('click', function(e) {
        e.preventDefault();
        fileInput.click();
    });
    
    // Drop zone click
    dropZone.addEventListener('click', function(e) {
        if (e.target !== browseBtn) {
            fileInput.click();
        }
    });
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        if (e.target.files[0]) {
            handleFile(e.target.files[0]);
        }
    });
    
    // Drag and drop
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    
    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.classList.remove('dragover');
    });
    
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files[0]) {
            handleFile(e.dataTransfer.files[0]);
        }
    });
}

function setupTextUpload() {
    const textarea = document.getElementById('resume-textarea');
    const counter = document.getElementById('char-counter');
    
    textarea.addEventListener('input', function() {
        currentText = this.value;
        counter.textContent = currentText.length;
        validateContinue();
    });
}

function handleFile(file) {
    // Validate
    if (file.size > 5 * 1024 * 1024) {
        showMessage('File must be less than 5MB', 'error');
        return;
    }
    
    const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
    if (!allowedTypes.includes(file.type)) {
        showMessage('Please upload PDF, DOCX, or TXT files only', 'error');
        return;
    }
    
    currentFile = file;
    
    // Show success
    document.getElementById('file-result').innerHTML = `
        <div class="file-success">
            <i class="fas fa-check-circle"></i>
            <span><strong>${file.name}</strong> (${(file.size/1024/1024).toFixed(1)}MB)</span>
            <button onclick="clearFile()" class="clear-btn">×</button>
        </div>
    `;
    document.getElementById('file-result').style.display = 'block';
    
    showMessage('File uploaded successfully!', 'success');
    validateContinue();
}

function clearFile() {
    currentFile = null;
    document.getElementById('file-result').style.display = 'none';
    document.getElementById('file-input').value = '';
    validateContinue();
}

function resetInputs() {
    // Clear file
    clearFile();
    
    // Clear text
    document.getElementById('resume-textarea').value = '';
    document.getElementById('char-counter').textContent = '0';
    currentText = '';
    
    // Clear messages
    document.getElementById('upload-messages').innerHTML = '';
}

function validateContinue() {
    const continueBtn = document.getElementById('continue-button');
    const activeType = document.querySelector('.upload-type-btn.active').dataset.type;
    
    let isValid = false;
    
    if (activeType === 'file') {
        isValid = currentFile !== null;
    } else if (activeType === 'text') {
        isValid = currentText.trim().length > 100;
        
        if (currentText.length > 0 && currentText.length <= 100) {
            showMessage('Please enter at least 100 characters', 'warning');
        } else if (isValid) {
            clearMessages();
        }
    }
    
    continueBtn.disabled = !isValid;
}

function showMessage(text, type) {
    const container = document.getElementById('upload-messages');
    const icons = {
        success: 'check-circle',
        error: 'exclamation-triangle',
        warning: 'info-circle'
    };
    
    container.innerHTML = `
        <div class="message ${type}">
            <i class="fas fa-${icons[type]}"></i>
            ${text}
        </div>
    `;
}

function clearMessages() {
    document.getElementById('upload-messages').innerHTML = '';
}

function proceedToNextStep() {
    const activeType = document.querySelector('.upload-type-btn.active').dataset.type;
    
    if (activeType === 'file' && currentFile) {
        // Store file reference for next step
        window.uploadedFile = currentFile;
        showMessage('Ready for job description step (COMMIT 2)', 'success');
    } else if (activeType === 'text' && currentText.trim().length > 100) {
        // Store text for next step
        window.uploadedText = currentText;
        showMessage('Ready for job description step (COMMIT 2)', 'success');
    }
}
</script>
{% endblock %}